{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<!-- Отладочная информация -->
{% if debug_info %}
<div class="alert alert-warning mt-3">
    <h6>Отладочная информация:</h6>
    <ul>
        <li>Роль пользователя: {{ debug_info.user_role }}</li>
        <li>Статус задачи: {{ debug_info.task_status }}</li>
        <li>Задача завершена: {{ debug_info.task_is_completed }}</li>
        <li>Пользователь может просматривать: {{ debug_info.user_can_view }}</li>
        <li>Пользователь может редактировать: {{ debug_info.user_can_edit }}</li>
    </ul>
</div>
{% endif %}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>{% trans 'Детали задачи' %}: {{ task.title }}</h2>
            
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{{ task.title }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>{% trans 'Тип задачи:' %}</strong> {{ task.get_task_type_display }}</p>
                            <p><strong>{% trans 'Статус:' %}</strong> {{ task.get_status_display }}</p>
                            <p><strong>{% trans 'Активная:' %}</strong> {% if task.is_active %}{% trans 'Да' %}{% else %}{% trans 'Нет' %}{% endif %}</p>
                            {% if task.client %}
                                <p><strong>{% trans 'Клиент:' %}</strong> {{ task.client.name }}</p>
                                {% if task.client.address %}
                                    <p><strong>{% trans 'Адрес:' %}</strong> {{ task.client.address }}</p>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p><strong>{% trans 'Создано:' %}</strong> {{ task.created_at|date:"d.m.Y H:i" }}</p>
                            {% if task.created_by %}
                                <p><strong>{% trans 'Создал:' %}</strong> {{ task.created_by.username }}</p>
                            {% endif %}
                            {% if task.assigned_to %}
                                <p><strong>{% trans 'Назначено:' %}</strong> {{ task.assigned_to.username }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Для анкет показываем план и выполнение -->
                    {% if task.task_type == 'SURVEY' %}
                        <div class="mt-3">
                            <h6>{% trans 'План выполнения' %}</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ task.get_completion_percentage }}%" aria-valuenow="{{ task.get_completion_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <p>{% trans 'Цель:' %} {{ task.target_count }} | {% trans 'Выполнено:' %} {{ task.current_count }} | {% trans 'Процент:' %} {{ task.get_completion_percentage }}%</p>
                        </div>
                    {% endif %}
                    
                    {% if task.description %}
                        <div class="mt-3">
                            <strong>{% trans 'Описание:' %}</strong>
                            <p>{{ task.description }}</p>
                        </div>
                    {% endif %}
                    
                    {% if task.moderator_comment %}
                        <div class="mt-3 alert alert-warning">
                            <strong>{% trans 'Комментарий модератора:' %}</strong>
                            <p>{{ task.moderator_comment }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Действия -->
            <div class="mb-4">
                {% if user.role == 'EMPLOYEE' %}
                    <!-- Отладочная информация -->
                    <div class="alert alert-info mb-3">
                        Тип задачи: {{ task.task_type }} ({{ task.get_task_type_display }})
                    </div>
                    
                    {% if task.task_type == 'SURVEY' %}
                        {% if task.status != 'COMPLETED' and task.is_active and (task.target_count == 0 or task.current_count < task.target_count) %}
                            <a href="{% url 'tasks:survey_response' task.pk %}" class="btn btn-success me-2">{% trans 'Заполнить анкету' %}</a>
                        {% else %}
                            <button type="button" class="btn btn-secondary me-2" disabled>
                                {% if task.status == 'COMPLETED' %}{% trans 'Завершена' %}
                                {% elif not task.is_active %}{% trans 'Неактивна' %}
                                {% elif task.current_count >= task.target_count %}{% trans 'Цель достигнута' %}
                                {% else %}{% trans 'Недоступна' %}{% endif %}
                            </button>
                        {% endif %}
                    {% elif task.task_type == 'EQUIPMENT_PHOTO' or task.task_type == 'SIMPLE_PHOTO' %}
                        {% if task.status != 'COMPLETED' %}
                            <a href="#" class="btn btn-success me-2">{% trans 'Загрузить фото' %}</a>
                        {% else %}
                            <button type="button" class="btn btn-secondary me-2" disabled>{% trans 'Завершено' %}</button>
                        {% endif %}
                    {% else %}
                        {% if task.status != 'COMPLETED' %}
                            <!-- Форма для выполнения задачи -->
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success me-2">{% trans 'Выполнить задачу' %}</button>
                            </form>
                        {% else %}
                            <button type="button" class="btn btn-secondary me-2" disabled>{% trans 'Завершено' %}</button>
                        {% endif %}
                    {% endif %}
                {% endif %}
                
                {% if user.role == 'MODERATOR' %}
                    <a href="#" class="btn btn-primary me-2">{% trans 'Редактировать' %}</a>
                    <a href="#" class="btn btn-danger">{% trans 'Удалить' %}</a>
                {% endif %}
            </div>
            
            <!-- Возвращение на список задач -->
            <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary">{% trans 'Назад к списку задач' %}</a>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">{% trans 'На главную' %}</a>
        </div>
    </div>
</div>
{% endblock %}